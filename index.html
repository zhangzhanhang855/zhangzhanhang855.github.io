<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ZZH Music Player - éŸ³ä¹æ’­æ”¾å™¨</title>
  <style>
    :root {
      --golden-ratio: 1.618;
      --base-spacing: 16px;
      --golden-spacing: calc(var(--base-spacing) * var(--golden-ratio));
      --primary-color: #00e5ff;
      --primary-dark: #00d4ff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0a0a0a;
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: var(--base-spacing);
      overflow-y: auto;
      overflow-x: auto;
    }

    /* åŠ¨æ€èƒŒæ™¯ */
    .bg-blur {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      filter: blur(40px) brightness(0.3);
      opacity: 0;
      transition: opacity 0.8s ease;
      z-index: 0;
    }

    .bg-blur.active {
      opacity: 1;
    }

    /* ä¸»å®¹å™¨ - æ’­æ”¾å™¨å±…ä¸­å¸ƒå±€ */
    .container {
      display: grid;
      grid-template-columns: 1fr 380px 1fr;
      grid-template-rows: auto auto auto;
      gap: var(--base-spacing);
      max-width: 1600px;
      width: 100%;
      position: relative;
      z-index: 1;
      padding: var(--base-spacing) 0;
      align-items: start;
    }

    /* å·¦åˆ—ï¼šæ’­æ”¾åˆ—è¡¨ */
    .left-column {
      display: flex;
      flex-direction: column;
      gap: calc(var(--base-spacing) - 2px);
      grid-column: 1;
      grid-row: 1 / 4;
      min-width: 0;
    }

    /* ä¸­åˆ—ï¼šæ’­æ”¾å™¨ï¼ˆå±…ä¸­ï¼‰ */
    .middle-column {
      display: flex;
      flex-direction: column;
      gap: var(--base-spacing);
      grid-column: 2;
      grid-row: 2;
      justify-self: center;
    }

    /* å³åˆ—ï¼šMVå’Œå¯è§†åŒ– */
    .right-column {
      display: flex;
      flex-direction: column;
      gap: calc(var(--base-spacing) - 2px);
      grid-column: 3;
      grid-row: 1 / 4;
      min-width: 0;
    }

    /* æ’­æ”¾å™¨ä¸»ä½“ */
    .player {
      width: 100%;
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(10px);
      padding: calc(var(--base-spacing) * 1.5) calc(var(--base-spacing) * 1.25);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 229, 255, 0.15);
      border: 1px solid rgba(0, 229, 255, 0.1);
      text-align: center;
      animation: slideIn 0.6s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* å°é¢ */
    .cover {
      width: 100%;
      aspect-ratio: 1;
      background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
      margin-bottom: var(--base-spacing);
      border-radius: 12px;
      object-fit: cover;
      box-shadow: 0 10px 30px rgba(0, 229, 255, 0.15);
      border: 2px solid rgba(0, 229, 255, 0.1);
      animation: coverRotate 0.6s ease;
    }

    @keyframes coverRotate {
      from {
        transform: scale(0.8) rotateY(10deg);
      }
      to {
        transform: scale(1) rotateY(0);
      }
    }

    /* æ ‡é¢˜å’Œä¿¡æ¯ */
    .song-info {
      margin-bottom: calc(var(--base-spacing) - 2px);
    }

    .title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: calc(var(--base-spacing) / 2.618);
      color: var(--primary-color);
      text-shadow: 0 2px 10px rgba(0, 229, 255, 0.3);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .time-info {
      font-size: 11px;
      color: #888;
      display: flex;
      justify-content: space-between;
      margin-top: calc(var(--base-spacing) / 2.618);
    }

    /* è¿›åº¦æ¡ */
    .progress-container {
      width: 100%;
      height: 6px;
      background: rgba(68, 68, 68, 0.6);
      border-radius: 3px;
      cursor: pointer;
      margin: var(--base-spacing) 0;
      overflow: hidden;
      transition: height 0.2s;
    }

    .progress-container:hover {
      height: 8px;
    }

    .progress {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      border-radius: 3px;
      box-shadow: 0 0 10px rgba(0, 229, 255, 0.6);
      transition: width 0.1s linear;
    }

    /* æ§åˆ¶æŒ‰é’® */
    .controls {
      display: flex;
      gap: calc(var(--base-spacing) / 2);
      justify-content: center;
      margin-bottom: var(--base-spacing);
      flex-wrap: wrap;
    }

    .controls button {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      border: none;
      color: #000;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0, 229, 255, 0.3);
      flex: 1;
      min-width: 60px;
    }

    .controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 229, 255, 0.5);
    }

    .controls button:active {
      transform: translateY(0);
    }

    #playBtn {
      flex: 1.2;
      font-size: 13px;
    }

    /* è¾…åŠ©æ§åˆ¶ */
    .secondary-controls {
      display: flex;
      gap: calc(var(--base-spacing) / 2);
      justify-content: center;
      flex-wrap: wrap;
    }

    .secondary-controls button {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      border: none;
      color: #000;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 11px;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0, 229, 255, 0.3);
      flex: 1;
      min-width: 50px;
    }

    .secondary-controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 229, 255, 0.5);
    }

    .secondary-controls button:active {
      transform: translateY(0);
    }

    .secondary-controls button.lyrics-btn {
      background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
      box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
    }

    .secondary-controls button.lyrics-btn:hover {
      box-shadow: 0 6px 20px rgba(156, 39, 176, 0.5);
    }

    .secondary-controls button.shuffle-btn {
      background: linear-gradient(135deg, #ff6b9d 0%, #f06595 100%);
      box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
    }

    .secondary-controls button.shuffle-btn:hover {
      box-shadow: 0 6px 20px rgba(255, 107, 157, 0.5);
    }

    .secondary-controls button.shuffle-btn.active {
      background: linear-gradient(135deg, #ff1493 0%, #c71585 100%);
      box-shadow: 0 6px 20px rgba(255, 20, 147, 0.6);
    }

    .secondary-controls button.mv-btn {
      background: linear-gradient(135deg, #ff6b9d 0%, #f06595 100%);
      box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
    }

    .secondary-controls button.mv-btn:hover {
      box-shadow: 0 6px 20px rgba(255, 107, 157, 0.5);
    }

    .secondary-controls button.mv-btn.active {
      background: linear-gradient(135deg, #ff1493 0%, #c71585 100%);
      box-shadow: 0 6px 20px rgba(255, 20, 147, 0.6);
    }

    /* éŸ³é‡æ§åˆ¶ */
    .volume-control {
      display: flex;
      align-items: center;
      gap: calc(var(--base-spacing) / 2);
      padding: var(--base-spacing);
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      margin-bottom: var(--base-spacing);
      border: 1px solid rgba(0, 229, 255, 0.1);
    }

    .volume-icon {
      font-size: 16px;
      min-width: 22px;
      text-align: center;
    }

    .volume-slider {
      flex: 1;
      height: 5px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(68, 68, 68, 0.6);
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0, 229, 255, 0.5);
      transition: all 0.2s;
    }

    .volume-slider::-webkit-slider-thumb:hover {
      transform: scale(1.3);
      box-shadow: 0 0 15px rgba(0, 229, 255, 0.8);
    }

    .volume-slider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 8px rgba(0, 229, 255, 0.5);
      transition: all 0.2s;
    }

    .volume-slider::-moz-range-thumb:hover {
      transform: scale(1.3);
      box-shadow: 0 0 15px rgba(0, 229, 255, 0.8);
    }

    .volume-value {
      min-width: 32px;
      text-align: right;
      font-size: 11px;
      color: var(--primary-color);
      font-weight: 600;
    }

    /* ä¸‹è½½æŒ‰é’® */
    .download-controls {
      display: flex;
      gap: calc(var(--base-spacing) / 2);
      flex-wrap: wrap;
      justify-content: center;
    }

    .download-btn {
      background: linear-gradient(135deg, #ff6b9d 0%, #f06595 100%);
      border: none;
      color: #fff;
      padding: 7px 11px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
      min-width: 80px;
      justify-content: center;
    }

    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 157, 0.5);
    }

    .download-btn:active {
      transform: translateY(0);
    }

    .download-btn.cover {
      background: linear-gradient(135deg, #ffa502 0%, #ff8c42 100%);
      box-shadow: 0 4px 12px rgba(255, 165, 2, 0.3);
    }

    .download-btn.cover:hover {
      box-shadow: 0 6px 20px rgba(255, 165, 2, 0.5);
    }

    /* æ­Œæ›²åˆ—è¡¨ */
    .playlist {
      width: 100%;
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(10px);
      padding: calc(var(--base-spacing) * 1.1);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 229, 255, 0.15);
      border: 1px solid rgba(0, 229, 255, 0.1);
      animation: slideIn 0.6s ease 0.1s both;
      max-height: 600px;
      overflow-y: auto;
    }

    .playlist::-webkit-scrollbar {
      width: 5px;
    }

    .playlist::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    .playlist::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 8px;
    }

    .playlist::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    .playlist-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: var(--base-spacing);
      color: var(--primary-color);
      text-shadow: 0 2px 10px rgba(0, 229, 255, 0.3);
      display: flex;
      align-items: center;
      gap: calc(var(--base-spacing) / 2.618);
    }

    .playlist-title::before {
      content: "â™«";
      font-size: 18px;
    }

    .song-item {
      padding: 10px 12px;
      margin-bottom: calc(var(--base-spacing) / 2.618);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(0, 229, 255, 0.1);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: calc(var(--base-spacing) / 1.618);
    }

    .song-item:hover {
      background: rgba(0, 229, 255, 0.1);
      border-color: rgba(0, 229, 255, 0.3);
      transform: translateX(3px);
    }

    .song-item.active {
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.2) 0%, rgba(0, 212, 255, 0.2) 100%);
      border-color: var(--primary-color);
      box-shadow: 0 0 12px rgba(0, 229, 255, 0.25);
    }

    .song-number {
      font-size: 11px;
      color: #888;
      min-width: 22px;
      font-weight: 600;
      text-align: center;
    }

    .song-item.active .song-number {
      color: var(--primary-color);
    }

    .song-name {
      flex: 1;
      text-align: left;
      font-size: 13px;
      color: #ddd;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .song-item.active .song-name {
      color: var(--primary-color);
      font-weight: 600;
    }

    .play-icon {
      font-size: 11px;
      color: var(--primary-color);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .song-item.active .play-icon {
      opacity: 1;
    }

    /* æ­Œè¯æ˜¾ç¤ºé¢æ¿ */
    .lyrics-panel {
      width: 100%;
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(10px);
      padding: calc(var(--base-spacing) * 1.1);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 229, 255, 0.15);
      border: 1px solid rgba(0, 229, 255, 0.1);
      animation: slideIn 0.6s ease 0.2s both;
      display: flex;
      flex-direction: column;
      gap: var(--base-spacing);
      max-height: 550px;
      overflow: hidden;
    }

    .lyrics-panel.hidden {
      display: none;
    }

    .lyrics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: calc(var(--base-spacing) / 2);
    }

    .lyrics-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--primary-color);
      text-shadow: 0 2px 10px rgba(0, 229, 255, 0.3);
      display: flex;
      align-items: center;
      gap: calc(var(--base-spacing) / 2.618);
    }

    .lyrics-title::before {
      content: "â™ª";
      font-size: 18px;
    }

    .lyrics-toggle {
      background: rgba(0, 229, 255, 0.1);
      border: 1px solid rgba(0, 229, 255, 0.3);
      color: var(--primary-color);
      padding: 3px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .lyrics-toggle:hover {
      background: rgba(0, 229, 255, 0.2);
      border-color: var(--primary-color);
    }

    .lyrics-toggle.active {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: #000;
      border-color: var(--primary-color);
    }

    /* æ­Œè¯å®¹å™¨ */
    .lyrics-container {
      height: 440px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      overflow-y: auto;
      padding: var(--base-spacing);
      display: flex;
      flex-direction: column;
      gap: calc(var(--base-spacing) / 1.618);
      scroll-behavior: smooth;
      border: 1px solid rgba(0, 229, 255, 0.1);
    }

    .lyrics-container::-webkit-scrollbar {
      width: 5px;
    }

    .lyrics-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    .lyrics-container::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 8px;
    }

    .lyrics-container::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* æ­Œè¯è¡Œ */
    .lyric-line {
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.3s ease;
      color: #999;
      font-size: 13px;
      line-height: 1.5;
      text-align: center;
      cursor: pointer;
      border-left: 3px solid transparent;
    }

    .lyric-line:hover {
      background: rgba(0, 229, 255, 0.1);
      border-left-color: var(--primary-color);
      color: #ccc;
    }

    /* å½“å‰æ­Œè¯è¡Œ */
    .lyric-line.active {
      color: var(--primary-color);
      background: rgba(0, 229, 255, 0.15);
      border-left-color: var(--primary-color);
      font-weight: 600;
      font-size: 14px;
      transform: scale(1.05);
      box-shadow: 0 0 12px rgba(0, 229, 255, 0.25);
    }

    /* æ— æ­Œè¯æç¤º */
    .no-lyrics {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #666;
      font-size: 13px;
      text-align: center;
    }

    /* éŸ³é¢‘å¯è§†åŒ–é¢æ¿ */
    .visualizer-panel {
      width: 100%;
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(10px);
      padding: calc(var(--base-spacing) * 1.1);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 229, 255, 0.15);
      border: 1px solid rgba(0, 229, 255, 0.1);
      animation: slideIn 0.6s ease;
      display: flex;
      flex-direction: column;
      gap: var(--base-spacing);
      overflow: hidden;
    }

    .visualizer-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--primary-color);
      text-shadow: 0 2px 10px rgba(0, 229, 255, 0.3);
      display: flex;
      align-items: center;
      gap: calc(var(--base-spacing) / 2.618);
    }

    .visualizer-title::before {
      content: "ğŸ“Š";
      font-size: 18px;
    }

    .visualizer-controls {
      display: flex;
      gap: calc(var(--base-spacing) / 2);
      flex-wrap: wrap;
    }

    .visualizer-controls button {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      border: none;
      color: #000;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 11px;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0, 229, 255, 0.3);
      flex: 1;
      min-width: 70px;
    }

    .visualizer-controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 229, 255, 0.5);
    }

    .visualizer-controls button.active {
      background: linear-gradient(135deg, #ff1493 0%, #c71585 100%);
      box-shadow: 0 6px 20px rgba(255, 20, 147, 0.6);
    }

    /* Canvas å®¹å™¨ */
    .canvas-container {
      width: 100%;
      height: 200px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(0, 229, 255, 0.2);
    }

    .canvas-container canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* éŸ³é¢‘ç»Ÿè®¡ä¿¡æ¯ */
    .audio-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: calc(var(--base-spacing) / 2);
      padding: var(--base-spacing);
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(0, 229, 255, 0.1);
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      font-size: 11px;
      color: #888;
      font-weight: 600;
      text-transform: uppercase;
    }

    .stat-value {
      font-size: 14px;
      color: var(--primary-color);
      font-weight: 700;
      font-family: 'Courier New', monospace;
    }

    /* MVå®¹å™¨ */
    .mv-panel {
      width: 100%;
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(10px);
      padding: calc(var(--base-spacing) * 1.1);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 229, 255, 0.15);
      border: 1px solid rgba(0, 229, 255, 0.1);
      animation: slideIn 0.6s ease;
      display: flex;
      flex-direction: column;
      gap: var(--base-spacing);
      overflow: hidden;
    }

    .mv-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--primary-color);
      text-shadow: 0 2px 10px rgba(0, 229, 255, 0.3);
      display: flex;
      align-items: center;
      gap: calc(var(--base-spacing) / 2.618);
    }

    .mv-title::before {
      content: "ğŸ¬";
      font-size: 18px;
    }

    .youtube-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      border-radius: 12px;
      background: #000;
      border: 1px solid rgba(0, 229, 255, 0.2);
    }

    .youtube-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
    }

    .mv-toggle-btn {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      border: none;
      color: #000;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0, 229, 255, 0.3);
      width: 100%;
    }

    .mv-toggle-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 229, 255, 0.5);
    }

    .mv-panel.hidden {
      display: none;
    }

    .mv-info {
      font-size: 12px;
      color: #888;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border-left: 3px solid var(--primary-color);
    }

    /* åŠ è½½çŠ¶æ€æç¤º */
    .toast {
      position: fixed;
      bottom: 15px;
      right: 15px;
      background: rgba(0, 229, 255, 0.95);
      color: #000;
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 12px;
      animation: slideInUp 0.3s ease;
      box-shadow: 0 4px 20px rgba(0, 229, 255, 0.4);
      z-index: 1000;
    }

    .toast.success {
      background: rgba(76, 175, 80, 0.95);
    }

    .toast.error {
      background: rgba(244, 67, 54, 0.95);
    }

    @keyframes slideInUp {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideOutDown {
      from {
        transform: translateY(0);
        opacity: 1;
      }
      to {
        transform: translateY(100px);
        opacity: 0;
      }
    }

    .toast.hide {
      animation: slideOutDown 0.3s ease forwards;
    }

    /* å“åº”å¼è®¾è®¡ - å¤§å±å¹• */
    @media (min-width: 1400px) {
      .container {
        grid-template-columns: 1fr 400px 1fr;
      }

      .left-column {
        max-height: 800px;
      }

      .right-column {
        max-height: 800px;
      }

      .playlist {
        max-height: 500px;
      }

      .lyrics-panel {
        max-height: 500px;
      }

      .lyrics-container {
        height: 380px;
      }

      .visualizer-panel {
        max-height: 400px;
      }

      .canvas-container {
        height: 180px;
      }

      .mv-panel {
        max-height: 450px;
      }
    }

    /* å“åº”å¼è®¾è®¡ - ä¸­ç­‰å±å¹• */
    @media (min-width: 1024px) and (max-width: 1399px) {
      .container {
        grid-template-columns: 0.9fr 350px 0.9fr;
      }

      .left-column {
        max-height: 700px;
      }

      .right-column {
        max-height: 700px;
      }

      .playlist {
        max-height: 450px;
      }

      .lyrics-panel {
        max-height: 450px;
      }

      .lyrics-container {
        height: 320px;
      }

      .visualizer-panel {
        max-height: 350px;
      }

      .canvas-container {
        height: 150px;
      }

      .mv-panel {
        max-height: 400px;
      }

      .player {
        padding: 16px 12px;
      }

      .cover {
        margin-bottom: 12px;
      }

      .title {
        font-size: 14px;
      }

      .controls button {
        padding: 6px 8px;
        font-size: 11px;
      }

      .secondary-controls button {
        font-size: 10px;
        padding: 4px 6px;
        min-width: 40px;
      }
    }

    /* å¹³æ¿ç«–å± */
    @media (min-width: 768px) and (max-width: 1023px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
      }

      .left-column {
        grid-column: 1;
        grid-row: 3;
        max-height: 400px;
      }

      .middle-column {
        grid-column: 1;
        grid-row: 2;
      }

      .right-column {
        grid-column: 1;
        grid-row: 4;
      }

      .visualizer-panel {
        order: 1;
      }

      .mv-panel {
        display: none;
      }

      .player {
        padding: 24px 16px;
      }

      .playlist {
        max-height: 400px;
      }

      .lyrics-panel {
        max-height: 400px;
      }

      .lyrics-container {
        height: 280px;
      }

      .canvas-container {
        height: 160px;
      }
    }

    /* æ‰‹æœºç«–å± */
    @media (max-width: 767px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
        gap: var(--base-spacing);
      }

      .left-column {
        grid-column: 1;
        grid-row: 3;
        max-height: 400px;
      }

      .middle-column {
        grid-column: 1;
        grid-row: 2;
      }

      .right-column {
        grid-column: 1;
        grid-row: 4;
      }

      .visualizer-panel {
        order: 1;
      }

      .mv-panel {
        display: none;
      }

      .player {
        padding: 20px 12px;
      }

      .cover {
        margin-bottom: 12px;
      }

      .title {
        font-size: 14px;
      }

      .controls button {
        padding: 6px 8px;
        font-size: 11px;
      }

      .secondary-controls button {
        font-size: 10px;
        padding: 4px 6px;
        min-width: 40px;
      }

      .playlist {
        max-height: 400px;
      }

      .lyrics-panel {
        max-height: 400px;
      }

      .lyrics-container {
        height: 280px;
      }

      .canvas-container {
        height: 140px;
      }

      .visualizer-controls {
        flex-wrap: wrap;
      }

      .visualizer-controls button {
        flex: 1;
        min-width: 60px;
      }

      .audio-stats {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* éŸ³é¢‘å…ƒç´ éšè— */
    audio {
      display: none;
    }
  </style>
</head>
<body>

<!-- åŠ¨æ€èƒŒæ™¯ -->
<div class="bg-blur" id="bgBlur"></div>

<!-- ä¸»å®¹å™¨ -->
<div class="container">
  <!-- å·¦åˆ—ï¼šæ’­æ”¾åˆ—è¡¨ -->
  <div class="left-column">
    <div class="playlist">
      <div class="playlist-title">æ’­æ”¾åˆ—è¡¨</div>
      <div id="playlistContainer"></div>
    </div>
  </div>

  <!-- ä¸­åˆ—ï¼šæ’­æ”¾å™¨ï¼ˆå±…ä¸­ï¼‰ -->
  <div class="middle-column">
    <div class="player">
      <img src="" id="cover" class="cover" alt="æ­Œæ›²å°é¢" />
      
      <div class="song-info">
        <div class="title" id="songTitle">åŠ è½½ä¸­...</div>
        <div class="time-info">
          <span id="currentTime">00:00</span>
          <span id="duration">00:00</span>
        </div>
      </div>

      <div class="progress-container" id="progressContainer">
        <div class="progress" id="progress"></div>
      </div>

      <div class="controls">
        <button onclick="prevSong()">â®ï¸</button>
        <button onclick="togglePlay()" id="playBtn">â–¶ï¸ æ’­æ”¾</button>
        <button onclick="nextSong()">â­ï¸</button>
      </div>

      <div class="secondary-controls">
        <button onclick="toggleLoop()" id="loopBtn">ğŸ” å¾ªç¯</button>
        <button class="shuffle-btn" onclick="toggleShuffle()" id="shuffleBtn">ğŸ”€ éšæœº</button>
        <button class="mv-btn" onclick="toggleMVPanel()" id="mvShowBtn">ğŸ¬ MV</button>
        <button class="lyrics-btn" onclick="toggleLyricsPanel()" id="lyricsShowBtn">ğŸ“œ æ­Œè¯</button>
      </div>

      <!-- éŸ³é‡æ§åˆ¶ -->
      <div class="volume-control">
        <span class="volume-icon">ğŸ”Š</span>
        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="70">
        <span class="volume-value" id="volumeValue">70%</span>
      </div>

      <!-- ä¸‹è½½åŠŸèƒ½ -->
      <div class="download-controls">
        <button class="download-btn" onclick="downloadAudio()">
          <span>â¬‡ï¸</span>
          <span>éŸ³é¢‘</span>
        </button>
        <button class="download-btn cover" onclick="downloadCover()">
          <span>â¬‡ï¸</span>
          <span>å°é¢</span>
        </button>
      </div>
    </div>
  </div>

  <!-- å³åˆ—ï¼šå¯è§†åŒ–å’ŒMV -->
  <div class="right-column">
    <!-- éŸ³é¢‘å¯è§†åŒ–é¢æ¿ -->
    <div class="visualizer-panel" id="visualizerPanel">
      <div class="visualizer-title">éŸ³é¢‘åˆ†æ</div>
      
      <div class="visualizer-controls">
        <button onclick="switchVisualizer('frequency')" class="active" id="freqBtn">é¢‘è°±</button>
        <button onclick="switchVisualizer('waveform')" id="waveBtn">æ³¢å½¢</button>
        <button onclick="toggleVisualizer()" id="vizToggleBtn">å…³é—­</button>
      </div>

      <div class="canvas-container">
        <canvas id="visualizerCanvas"></canvas>
      </div>

      <div class="audio-stats">
        <div class="stat-item">
          <div class="stat-label">é¢‘ç‡ (Hz)</div>
          <div class="stat-value" id="freqValue">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">å¹…åº¦ (dB)</div>
          <div class="stat-value" id="ampValue">-âˆ</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">å¹³å‡éŸ³é‡</div>
          <div class="stat-value" id="volValue">0%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">å³°å€¼</div>
          <div class="stat-value" id="peakValue">0%</div>
        </div>
      </div>
    </div>

    <!-- MVæ’­æ”¾å™¨ -->
    <div class="mv-panel" id="mvPanel">
      <div class="mv-title">éŸ³ä¹è§†é¢‘ (MV)</div>
      <div class="youtube-container" id="youtubeContainer">
        <iframe 
          id="youtubeFrame"
          src="about:blank" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen>
        </iframe>
      </div>
      <div class="mv-info" id="mvInfo">
        ğŸ’¡ æç¤ºï¼šç‚¹å‡»æ’­æ”¾åˆ—è¡¨ä¸­çš„æ­Œæ›²ï¼Œå°†è‡ªåŠ¨åŠ è½½å¯¹åº”çš„MV
      </div>
      <button class="mv-toggle-btn" onclick="toggleMVPanel()">éšè—MV</button>
    </div>

    <!-- æ­Œè¯é¢æ¿ -->
    <div class="lyrics-panel" id="lyricsPanel">
      <div class="lyrics-header">
        <div class="lyrics-title">æ­Œè¯</div>
        <button class="lyrics-toggle active" id="lyricsToggle" onclick="toggleLyricsPanel()">éšè—</button>
      </div>
      <div class="lyrics-container" id="lyricsContainer">
        <div class="no-lyrics">æš‚æ— æ­Œè¯</div>
      </div>
    </div>
  </div>
</div>

<audio id="audio"></audio>

<script>
  const songs = [
    {
      name: "Faded - Alan Walker",
      url: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/Faded - Alan Walker.mp3",
      cover: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/Faded - Alan Walker.jpeg",
      youtubeId: "60ItHLz5WEA",
      lyrics: `[00:00.85]Faded (æ†”æ‚´ä¸å ª) - Alan Walker (è‰¾ä¼¦Â·æ²ƒå…‹)
[00:01.44]
[00:01.44]Written byï¼šAlan Walker
[00:11.32]
[00:11.32]You were the shadow to my light
[00:14.05]Did you feel us
[00:18.04]Another start
[00:19.85]You fade away
[00:21.75]Afraid our aim is out of sight
[00:24.86]Wanna see us
[00:28.68]Alight
[00:31.15]Where are you now
[00:36.46]Where are you now
[00:41.65]Where are you now
[00:44.51]Was it all in my fantasy
[00:47.28]Where are you now
[00:49.77]Were you only imaginary
[00:53.95]Where are you now
[00:57.38]Atlantis
[00:59.06]Under the sea
[01:01.66]Under the sea
[01:04.5]Where are you now
[01:07.06]Another dream
[01:10.62]The monsters running wild inside of me
[01:14.39]I'm faded
[01:19.92]I'm faded
[01:23.74]So lost
[01:25.41]I'm faded
[01:30.62]I'm faded
[01:34.55]So lost
[01:35.880005]I'm faded
[01:37.81]These shallow waters never met
[01:40.69]What I needed
[01:44.61]I'm letting go
[01:46.42]A deeper dive
[01:48.42]Eternal silence of the sea
[01:51.729996]I'm breathing
[01:55.270004]Alive
[01:57.96]Where are you now
[02:03.21]Where are you now
[02:08.51]Under the bright
[02:09.91]But faded lights
[02:11.1]You set my heart on fire
[02:13.82]Where are you now
[02:16.45999]Where are you now
[02:31.31]Where are you now
[02:34.66]Atlantis
[02:36.69]Under the sea
[02:39.12]Under the sea
[02:41.94]Where are you now
[02:44.33]Another dream
[02:47.8]The monsters running wild inside of me
[02:51.79001]I'm faded
[02:57.24]I'm faded
[03:01.12]So lost
[03:02.68]I'm faded
[03:08.03]I'm faded
[03:11.82]So lost
[03:13.12]I'm faded`
    },
    {
      name: "Heading Home - Alan Walker",
      url: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/Heading Home - Alan Walker [Normal Quality].mp3",
      cover: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/Heading Home - Alan Walker:Ruben.jpeg",
      youtubeId: "iVX_uBvb8nQ",
      lyrics: `[00:00.0]Heading Home - Alan Walker/Ruben`
    },
    {
      name: "Sunburst - Tobu",
      url: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/Sunburst - Tobu.mp3",
      cover: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/Sunburstï¼ˆäº‘éš™é˜³å…‰ï¼‰ - Tobu:Itro.jpeg",
      youtubeId: "KFpZCkxPHx4",
      lyrics: `[00:00.00]Empty`
    },
    {
      name: "World of Walker: Rise of the drones - Alan Walker",
      url: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/Rise of the drones.mp3",
      cover: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/World of Walker: Rise of the Drones - Alan Walker.jpeg",
      youtubeId: "D1cqIZPrvXo",
      lyrics: `[00:00.0]World of Walker: Rise of the Drones`
    },
    {
      name: "The Sky High - Elektronomia",
      url: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/The Sky High - Elektronomia.mp3",
      cover: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/The Sky High - Elektronomia.jpeg",
      youtubeId: "dAVOy1zj5iU",
      lyrics: `[00:04.34]I'm laying where the stars shine so bright`
    },
    {
      name: "365",
      url: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/365.mp3",
      cover: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/365 - Zedd:Katy Perry.jpeg",
      youtubeId: "VJHp-Dw0BzY",
      lyrics: `[00:00.0]365 - Zedd/Katy Perry`
    },
    {
      name: "BARRETE!",
      url: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/DERRETE!.mp3",
      cover: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/BARRETE! - CHASHKAKEFIRA:D4C.jpeg",
      youtubeId: "",
      lyrics: `[00:00.00]Empty`
    },
    {
      name: "å¥½ç©å—å­©å­",
      url: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/ScreenRecording_02-11-2026 13-57-19_1.m4a",
      cover: "https://raw.githubusercontent.com/zhangzhanhang855/zhangzhanhang855.github.io/main/IMG_3383.jpeg",
      youtubeId: "",
      lyrics: `[00:00.00]Empty`
    }
  ];

  // =============== éŸ³é¢‘å¯è§†åŒ–éƒ¨åˆ† ===============
  let audioContext = null;
  let analyser = null;
  let dataArray = null;
  let frequencyData = null;
  let canvas = null;
  let canvasCtx = null;
  let animationId = null;
  let visualizerMode = 'frequency'; // 'frequency' æˆ– 'waveform'
  let visualizerEnabled = true;

  function initAudioVisualizer() {
    if (audioContext) return;

    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioContext = new AudioContext();
      
      const source = audioContext.createMediaElementAudioSource(audio);
      analyser = audioContext.createAnalyser();
      
      analyser.fftSize = 2048;
      source.connect(analyser);
      analyser.connect(audioContext.destination);
      
      frequencyData = new Uint8Array(analyser.frequencyBinCount);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      
      canvas = document.getElementById('visualizerCanvas');
      canvasCtx = canvas.getContext('2d');
      
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      startVisualization();
    } catch (e) {
      console.error('Audio visualizer initialization failed:', e);
    }
  }

  function resizeCanvas() {
    if (!canvas) return;
    canvas.width = canvas.offsetWidth * window.devicePixelRatio;
    canvas.height = canvas.offsetHeight * window.devicePixelRatio;
    canvasCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
  }

  function startVisualization() {
    if (!visualizerEnabled || !analyser) return;

    const draw = () => {
      animationId = requestAnimationFrame(draw);
      
      if (visualizerMode === 'frequency') {
        drawFrequencyBars();
      } else {
        drawWaveform();
      }
      
      updateAudioStats();
    };

    draw();
  }

  function drawFrequencyBars() {
    analyser.getByteFrequencyData(frequencyData);
    
    const width = canvas.offsetWidth;
    const height = canvas.offsetHeight;
    
    // æ¸…é™¤èƒŒæ™¯
    canvasCtx.fillStyle = 'rgba(10, 10, 10, 0.8)';
    canvasCtx.fillRect(0, 0, width, height);
    
    const barCount = 64;
    const barWidth = width / barCount;
    const step = Math.floor(frequencyData.length / barCount);
    
    for (let i = 0; i < barCount; i++) {
      const value = frequencyData[i * step] || 0;
      const barHeight = (value / 255) * height;
      
      // æ¸å˜é¢œè‰²ï¼šé’è‰² -> ç´«è‰² -> ç²‰è‰²
      const hue = (i / barCount) * 120 + 180; // ä»é’è‰²åˆ°ç²‰è‰²
      canvasCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
      
      canvasCtx.fillRect(
        i * barWidth,
        height - barHeight,
        barWidth * 0.8,
        barHeight
      );
    }
  }

  function drawWaveform() {
    analyser.getByteFrequencyData(frequencyData);
    
    const width = canvas.offsetWidth;
    const height = canvas.offsetHeight;
    const centerY = height / 2;
    
    // æ¸…é™¤èƒŒæ™¯
    canvasCtx.fillStyle = 'rgba(10, 10, 10, 0.8)';
    canvasCtx.fillRect(0, 0, width, height);
    
    // ç»˜åˆ¶æ³¢å½¢çº¿
    canvasCtx.strokeStyle = '#00e5ff';
    canvasCtx.lineWidth = 2;
    canvasCtx.shadowColor = 'rgba(0, 229, 255, 0.6)';
    canvasCtx.shadowBlur = 10;
    canvasCtx.beginPath();
    
    const sliceWidth = width / frequencyData.length;
    let x = 0;
    
    for (let i = 0; i < frequencyData.length; i++) {
      const v = frequencyData[i] / 128.0;
      const y = (v * height) / 2;
      
      if (i === 0) {
        canvasCtx.moveTo(x, centerY - y);
      } else {
        canvasCtx.lineTo(x, centerY - y);
      }
      
      x += sliceWidth;
    }
    
    canvasCtx.lineTo(width, centerY);
    canvasCtx.stroke();
    canvasCtx.shadowColor = 'transparent';
  }

  function updateAudioStats() {
    if (!analyser) return;

    analyser.getByteFrequencyData(frequencyData);
    
    // è®¡ç®—å¹³å‡éŸ³é‡
    let sum = 0;
    for (let i = 0; i < frequencyData.length; i++) {
      sum += frequencyData[i];
    }
    const average = Math.round(sum / frequencyData.length);
    const volumePercent = Math.round((average / 255) * 100);
    
    // æ‰¾æœ€é«˜é¢‘ç‡
    let maxValue = 0;
    let maxIndex = 0;
    for (let i = 0; i < frequencyData.length; i++) {
      if (frequencyData[i] > maxValue) {
        maxValue = frequencyData[i];
        maxIndex = i;
      }
    }
    
    const nyquistFrequency = audioContext.sampleRate / 2;
    const frequency = (maxIndex / frequencyData.length) * nyquistFrequency;
    const amplitude = (maxValue / 255) * 100;
    
    document.getElementById('freqValue').textContent = Math.round(frequency);
    document.getElementById('ampValue').textContent = (Math.log10(maxValue / 255) * 20).toFixed(1);
    document.getElementById('volValue').textContent = volumePercent + '%';
    document.getElementById('peakValue').textContent = Math.round((maxValue / 255) * 100) + '%';
  }

  function switchVisualizer(mode) {
    visualizerMode = mode;
    
    document.getElementById('freqBtn').classList.remove('active');
    document.getElementById('waveBtn').classList.remove('active');
    
    if (mode === 'frequency') {
      document.getElementById('freqBtn').classList.add('active');
    } else {
      document.getElementById('waveBtn').classList.add('active');
    }
  }

  function toggleVisualizer() {
    visualizerEnabled = !visualizerEnabled;
    const btn = document.getElementById('vizToggleBtn');
    
    if (visualizerEnabled) {
      btn.textContent = 'å…³é—­';
      startVisualization();
    } else {
      btn.textContent = 'æ‰“å¼€';
      if (animationId) {
        cancelAnimationFrame(animationId);
      }
      const width = canvas.offsetWidth;
      const height = canvas.offsetHeight;
      canvasCtx.fillStyle = 'rgba(10, 10, 10, 0.8)';
      canvasCtx.fillRect(0, 0, width, height);
    }
  }

  // =============== åŸæœ‰æ’­æ”¾å™¨ä»£ç  ===============
  let index = 0;
  let isPlaying = false;
  let lyricsVisible = true;
  let mvVisible = true;
  let isShuffleMode = false;
  let playedIndices = [];

  const audio = document.getElementById("audio");
  const title = document.getElementById("songTitle");
  const cover = document.getElementById("cover");
  const progress = document.getElementById("progress");
  const playBtn = document.getElementById("playBtn");
  const loopBtn = document.getElementById("loopBtn");
  const shuffleBtn = document.getElementById("shuffleBtn");
  const progressContainer = document.getElementById("progressContainer");
  const bgBlur = document.getElementById("bgBlur");
  const currentTimeEl = document.getElementById("currentTime");
  const durationEl = document.getElementById("duration");
  const playlistContainer = document.getElementById("playlistContainer");
  const volumeSlider = document.getElementById("volumeSlider");
  const volumeValue = document.getElementById("volumeValue");
  const lyricsContainer = document.getElementById("lyricsContainer");
  const lyricsPanel = document.getElementById("lyricsPanel");
  const lyricsToggle = document.getElementById("lyricsToggle");
  const lyricsShowBtn = document.getElementById("lyricsShowBtn");
  const youtubeFrame = document.getElementById("youtubeFrame");
  const mvPanel = document.getElementById("mvPanel");
  const mvShowBtn = document.getElementById("mvShowBtn");
  const mvInfo = document.getElementById("mvInfo");

  function formatTime(time) {
    if (!time || isNaN(time)) return "00:00";
    const minutes = Math.floor(time / 60);
    const seconds = Math.floor(time % 60);
    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }

  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.classList.add('hide');
      setTimeout(() => toast.remove(), 300);
    }, 2500);
  }

  // =============== æ­Œè¯ç›¸å…³ ===============
  let currentLyricsIndex = 0;
  let parsedLyrics = [];

  function parseLyrics(lyricsText) {
    const lines = lyricsText.split('\n');
    const parsed = [];
    
    lines.forEach(line => {
      const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2})\](.*)/);
      if (match) {
        const minutes = parseInt(match[1]);
        const seconds = parseInt(match[2]);
        const time = minutes * 60 + seconds;
        const text = match[4].trim();
        parsed.push({ time, text });
      }
    });
    
    return parsed.sort((a, b) => a.time - b.time);
  }

  function renderLyrics() {
    if (!parsedLyrics || parsedLyrics.length === 0) {
      lyricsContainer.innerHTML = '<div class="no-lyrics">æš‚æ— æ­Œè¯</div>';
      return;
    }

    lyricsContainer.innerHTML = parsedLyrics.map((lyric, idx) => 
      `<div class="lyric-line" data-index="${idx}" onclick="jumpToLyricTime(${lyric.time})">${lyric.text}</div>`
    ).join('');
  }

  function updateCurrentLyric() {
    if (!parsedLyrics || parsedLyrics.length === 0) return;

    const currentTime = audio.currentTime;
    let newIndex = 0;

    for (let i = 0; i < parsedLyrics.length; i++) {
      if (parsedLyrics[i].time <= currentTime) {
        newIndex = i;
      } else {
        break;
      }
    }

    if (newIndex !== currentLyricsIndex) {
      const prevActive = lyricsContainer.querySelector('.lyric-line.active');
      if (prevActive) prevActive.classList.remove('active');

      currentLyricsIndex = newIndex;
      const newActive = lyricsContainer.querySelector(`[data-index="${newIndex}"]`);
      if (newActive) {
        newActive.classList.add('active');
        newActive.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }

  function jumpToLyricTime(time) {
    audio.currentTime = time;
    if (!isPlaying) {
      audio.play();
      isPlaying = true;
      playBtn.textContent = "â¸ï¸ æš‚åœ";
      bgBlur.classList.add("active");
    }
  }

  function toggleLyricsPanel() {
    lyricsVisible = !lyricsVisible;
    lyricsPanel.classList.toggle('hidden');
    lyricsToggle.textContent = lyricsVisible ? 'éšè—' : 'æ˜¾ç¤º';
    lyricsToggle.classList.toggle('active');
    lyricsShowBtn.textContent = lyricsVisible ? 'ğŸ“œ æ­Œè¯' : 'ğŸ“œ æ˜¾ç¤º';
  }

  // =============== MVç›¸å…³ ===============
  function loadYouTubeMV(youtubeId) {
    if (!youtubeId) {
      youtubeFrame.src = "about:blank";
      mvInfo.textContent = "âŒ æ­¤æ­Œæ›²æš‚æ— MV";
      return;
    }

    youtubeFrame.src = `https://www.youtube.com/embed/${youtubeId}?autoplay=0&controls=1&modestbranding=1`;
    mvInfo.textContent = "ğŸ¬ æ­£åœ¨åŠ è½½MVï¼Œè¯·ç¨å€™...";
  }

  function toggleMVPanel() {
    mvVisible = !mvVisible;
    mvPanel.classList.toggle('hidden');
    mvShowBtn.classList.toggle('active');
    mvShowBtn.textContent = mvVisible ? 'ğŸ¬ MV' : 'ğŸ¬ æ˜¾ç¤º';
  }

  // =============== éšæœºæ’­æ”¾ç›¸å…³ ===============
  function toggleShuffle() {
    isShuffleMode = !isShuffleMode;
    shuffleBtn.classList.toggle('active');
    
    if (isShuffleMode) {
      showToast('ğŸ”€ å·²å¯ç”¨éšæœºæ’­æ”¾', 'success');
      playedIndices = [index];
    } else {
      showToast('å·²å…³é—­éšæœºæ’­æ”¾', 'success');
      playedIndices = [];
    }
    
    updatePlaylist();
  }

  function getNextIndex() {
    if (isShuffleMode) {
      const unplayedIndices = [];
      for (let i = 0; i < songs.length; i++) {
        if (!playedIndices.includes(i)) {
          unplayedIndices.push(i);
        }
      }
      
      if (unplayedIndices.length === 0) {
        playedIndices = [];
        unplayedIndices.push(...Array.from({ length: songs.length }, (_, i) => i));
      }
      
      const randomIdx = Math.floor(Math.random() * unplayedIndices.length);
      const nextIdx = unplayedIndices[randomIdx];
      playedIndices.push(nextIdx);
      
      return nextIdx;
    } else {
      return (index + 1) % songs.length;
    }
  }

  // éŸ³é‡æ§åˆ¶
  volumeSlider.addEventListener('input', (e) => {
    const volume = e.target.value;
    audio.volume = volume / 100;
    volumeValue.textContent = `${volume}%`;
  });

  audio.volume = 0.7;

  // ä¸‹è½½åŠŸèƒ½
  function downloadFile(url, filename) {
    const xhr = new XMLHttpRequest();
    xhr.responseType = 'blob';
    
    xhr.onload = function() {
      const blob = xhr.response;
      const objectUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = objectUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(objectUrl);
      showToast(`å·²ä¸‹è½½: ${filename}`, 'success');
    };

    xhr.onerror = function() {
      showToast('ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
    };

    try {
      xhr.open('GET', url, true);
      xhr.send();
    } catch (error) {
      showToast('æ— æ³•ä¸‹è½½æ–‡ä»¶ï¼Œå¯èƒ½å­˜åœ¨è·¨åŸŸé—®é¢˜', 'error');
    }
  }

  function downloadAudio() {
    if (index >= 0 && index < songs.length) {
      const song = songs[index];
      const filename = `${song.name}.mp3`;
      showToast('æ­£åœ¨ä¸‹è½½éŸ³é¢‘...', 'success');
      downloadFile(song.url, filename);
    }
  }

  function downloadCover() {
    if (index >= 0 && index < songs.length) {
      const song = songs[index];
      const filename = `${song.name}-cover.jpg`;
      showToast('æ­£åœ¨ä¸‹è½½å°é¢...', 'success');
      downloadFile(song.cover, filename);
    }
  }

  // åŠ è½½æ­Œæ›²
  function loadSong(i) {
    index = i;
    audio.src = songs[i].url;
    title.textContent = songs[i].name;
    cover.src = songs[i].cover;
    bgBlur.style.backgroundImage = `url('${songs[i].cover}')`;
    
    // åŠ è½½MV
    loadYouTubeMV(songs[i].youtubeId);
    
    if (songs[i].lyrics) {
      parsedLyrics = parseLyrics(songs[i].lyrics);
      currentLyricsIndex = 0;
      renderLyrics();
    } else {
      lyricsContainer.innerHTML = '<div class="no-lyrics">æš‚æ— æ­Œè¯</div>';
      parsedLyrics = [];
    }
    
    updatePlaylist();
  }

  // æ’­æ”¾æ§åˆ¶
  function togglePlay() {
    if (!audioContext) {
      initAudioVisualizer();
    }

    if (isPlaying) {
      audio.pause();
      playBtn.textContent = "â–¶ï¸ æ’­æ”¾";
      bgBlur.classList.remove("active");
    } else {
      audio.play();
      playBtn.textContent = "â¸ï¸ æš‚åœ";
      bgBlur.classList.add("active");
    }
    isPlaying = !isPlaying;
  }

  function nextSong() {
    index = getNextIndex();
    loadSong(index);
    audio.play();
    isPlaying = true;
    playBtn.textContent = "â¸ï¸ æš‚åœ";
    bgBlur.classList.add("active");
  }

  function prevSong() {
    if (isShuffleMode) {
      if (playedIndices.length > 1) {
        playedIndices.pop();
        index = playedIndices[playedIndices.length - 1];
      } else {
        index = (index - 1 + songs.length) % songs.length;
      }
    } else {
      index = (index - 1 + songs.length) % songs.length;
    }
    
    loadSong(index);
    audio.play();
    isPlaying = true;
    playBtn.textContent = "â¸ï¸ æš‚åœ";
    bgBlur.classList.add("active");
  }

  function toggleLoop() {
    audio.loop = !audio.loop;
    loopBtn.textContent = audio.loop ? "ğŸ”„ å¾ªç¯ä¸­" : "ğŸ” å¾ªç¯";
  }

  // éŸ³é¢‘äº‹ä»¶
  audio.addEventListener("timeupdate", () => {
    const percent = (audio.currentTime / audio.duration) * 100;
    progress.style.width = percent + "%";
    currentTimeEl.textContent = formatTime(audio.currentTime);
    updateCurrentLyric();
  });

  audio.addEventListener("loadedmetadata", () => {
    durationEl.textContent = formatTime(audio.duration);
  });

  progressContainer.addEventListener("click", e => {
    const width = progressContainer.clientWidth;
    const clickX = e.offsetX;
    const duration = audio.duration;
    audio.currentTime = (clickX / width) * duration;
  });

  audio.addEventListener("ended", () => {
    if (!audio.loop) nextSong();
  });

  // æ’­æ”¾åˆ—è¡¨
  function updatePlaylist() {
    playlistContainer.innerHTML = songs.map((song, i) => `
      <div class="song-item ${i === index ? 'active' : ''}" onclick="loadSongAndPlay(${i})">
        <span class="song-number">${i + 1}</span>
        <span class="song-name" title="${song.name}">${song.name}</span>
        <span class="play-icon">â™«</span>
      </div>
    `).join('');
  }

  function loadSongAndPlay(i) {
    if (isShuffleMode) {
      playedIndices.push(i);
    }
    loadSong(i);
    audio.play();
    isPlaying = true;
    playBtn.textContent = "â¸ï¸ æš‚åœ";
    bgBlur.classList.add("active");
  }

  // åˆå§‹åŒ–
  loadSong(index);
  updatePlaylist();
</script>

</body>
</html>
