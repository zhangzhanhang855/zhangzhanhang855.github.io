<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æç®€æ–—åœ°ä¸» - äººæœºå¯¹æˆ˜</title>
    <style>
        :root {
            --bg-color: #2d5a27;
            --card-white: #ffffff;
            --card-red: #ff4d4d;
            --card-black: #333;
        }
        body { background-color: var(--bg-color); font-family: "Microsoft YaHei", sans-serif; margin: 0; overflow: hidden; color: white; }
        
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: space-between; }

        /* ç©å®¶åŒºåŸŸå¸ƒå±€ */
        .player-area { position: absolute; display: flex; flex-wrap: wrap; justify-content: center; width: 100%; transition: all 0.3s; }
        #player-bottom { bottom: 20px; height: 150px; }
        #player-left { left: 20px; top: 30%; width: 100px; flex-direction: column; }
        #player-right { right: 20px; top: 30%; width: 100px; flex-direction: column; }

        /* å¡ç‰Œæ ·å¼ */
        .card {
            width: 70px; height: 100px;
            background: var(--card-white);
            border-radius: 8px;
            margin: -25px 5px 0; /* å æ”¾æ•ˆæœ */
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 5px; box-sizing: border-box;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            cursor: pointer; position: relative; transition: transform 0.2s;
            user-select: none; border: 1px solid #ccc;
        }
        .card.selected { transform: translateY(-20px); border: 2px solid #ffeb3b; }
        .card.red { color: var(--card-red); }
        .card.black { color: var(--card-black); }
        .card-value { font-size: 20px; font-weight: bold; }
        .card-suit { font-size: 14px; align-self: flex-end; }

        /* éšè—å¯¹æ‰‹æ‰‹ç‰Œå†…å®¹ */
        .hidden-card { background: linear-gradient(135deg, #1a3a16 25%, #2d5a27 100%); border: 1px solid #ffffff55; }
        .hidden-card * { display: none; }

        /* æ§åˆ¶åŒº */
        #controls { position: absolute; bottom: 200px; width: 100%; display: flex; justify-content: center; gap: 20px; }
        button { padding: 10px 25px; font-size: 16px; border-radius: 20px; border: none; cursor: pointer; background: #f0ad4e; color: white; font-weight: bold; }
        button:hover { background: #ec971f; }
        button:disabled { background: #777; cursor: not-allowed; }

        /* æ¡Œé¢/å‡ºç‰ŒåŒº */
        #desk { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 10px; }
        .info-tag { background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; position: absolute; font-size: 12px; }
        
        #dizhu-cards { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="dizhu-cards"></div>
    
    <div class="info-tag" style="top:30%; left:130px;">ç”µè„‘1 (<span id="count1">0</span>å¼ )</div>
    <div id="player-left" class="player-area"></div>
    
    <div class="info-tag" style="top:30%; right:130px;">ç”µè„‘2 (<span id="count2">0</span>å¼ )</div>
    <div id="player-right" class="player-area"></div>

    <div id="desk"></div>

    <div id="controls">
        <button onclick="startGame()">é‡æ–°å¼€å§‹</button>
        <button id="btn-play" onclick="handlePlay()" disabled>å‡ºç‰Œ</button>
        <button id="btn-pass" onclick="handlePass()" disabled>ä¸è¦</button>
    </div>

    <div id="player-bottom" class="player-area"></div>
</div>

<script>
/** * æç®€æ–—åœ°ä¸»æ ¸å¿ƒé€»è¾‘
 */
const VALUES = ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2', 'å°ç‹', 'å¤§ç‹'];
const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
const VALUE_MAP = { '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14, '2':15, 'å°ç‹':16, 'å¤§ç‹':17 };

let deck = [];
let players = [[], [], []]; // 0: ç©å®¶, 1: å·¦ç”µè„‘, 2: å³ç”µè„‘
let lastMove = { playerIdx: -1, cards: [] }; 
let currentPlayer = 0;
let selectedCards = new Set();

// åˆå§‹åŒ–ç‰Œç»„
function createDeck() {
    deck = [];
    for (let v of VALUES.slice(0, 13)) {
        for (let s of SUITS) deck.push({ value: v, suit: s, power: VALUE_MAP[v], color: (s==='â™¥'||s==='â™¦'?'red':'black') });
    }
    deck.push({ value: 'å°ç‹', suit: 'ğŸƒ', power: 16, color: 'black' });
    deck.push({ value: 'å¤§ç‹', suit: 'ğŸƒ', power: 17, color: 'red' });
}

// æ´—ç‰Œå¹¶å‘ç‰Œ
function startGame() {
    createDeck();
    deck.sort(() => Math.random() - 0.5);
    
    players = [
        deck.slice(0, 17).sort((a,b) => b.power - a.power),
        deck.slice(17, 34).sort((a,b) => b.power - a.power),
        deck.slice(34, 51).sort((a,b) => b.power - a.power)
    ];
    
    // ç®€å•èµ·è§ï¼Œè¿™é‡Œå›ºå®šåœ°ä¸»ç‰Œç»™ç©å®¶(0)
    const dizhuCards = deck.slice(51);
    players[0] = [...players[0], ...dizhuCards].sort((a,b) => b.power - a.power);
    
    renderDizhuCards(dizhuCards);
    currentPlayer = 0;
    lastMove = { playerIdx: -1, cards: [] };
    selectedCards.clear();
    renderAll();
    updateButtons();
}

function renderDizhuCards(cards) {
    const container = document.getElementById('dizhu-cards');
    container.innerHTML = cards.map(c => `<div class="card ${c.color}" style="width:40px;height:60px;margin:0 2px;font-size:12px;">${c.value}</div>`).join('');
}

function renderAll() {
    // æ¸²æŸ“ç©å®¶æ‰‹ç‰Œ
    const pBottom = document.getElementById('player-bottom');
    pBottom.innerHTML = '';
    players[0].forEach((card, index) => {
        const div = document.createElement('div');
        div.className = `card ${card.color} ${selectedCards.has(index) ? 'selected' : ''}`;
        div.innerHTML = `<span class="card-value">${card.value}</span><span class="card-suit">${card.suit}</span>`;
        div.onclick = () => {
            if(selectedCards.has(index)) selectedCards.delete(index);
            else selectedCards.add(index);
            renderAll();
        };
        pBottom.appendChild(div);
    });

    // æ¸²æŸ“ç”µè„‘æ‰‹ç‰Œï¼ˆéšè—ï¼‰
    document.getElementById('player-left').innerHTML = players[1].map(() => '<div class="card hidden-card"></div>').join('');
    document.getElementById('player-right').innerHTML = players[2].map(() => '<div class="card hidden-card"></div>').join('');
    document.getElementById('count1').innerText = players[1].length;
    document.getElementById('count2').innerText = players[2].length;
}

function updateButtons() {
    document.getElementById('btn-play').disabled = (currentPlayer !== 0);
    document.getElementById('btn-pass').disabled = (currentPlayer !== 0 || lastMove.playerIdx === -1 || lastMove.playerIdx === 0);
}

// ç®€å•çš„ç‰Œå‹æ ¡éªŒ
function getMoveType(cards) {
    const len = cards.length;
    if (len === 0) return null;
    const sorted = [...cards].sort((a,b) => a.power - b.power);
    
    if (len === 1) return { type: 'single', power: sorted[0].power };
    if (len === 2 && sorted[0].power === sorted[1].power) return { type: 'pair', power: sorted[0].power };
    if (len === 2 && sorted[0].power >= 16 && sorted[1].power >= 16) return { type: 'bomb', power: 99 }; // ç‹ç‚¸
    if (len === 4 && sorted[0].power === sorted[3].power) return { type: 'bomb', power: sorted[0].power };
    
    // æ›´å¤šç‰Œå‹ï¼ˆé¡ºå­ã€ä¸‰å¸¦ç­‰ï¼‰æ­¤å¤„å¯æ‰©å±•...
    return null; 
}

function handlePlay() {
    const selected = Array.from(selectedCards).map(i => players[0][i]);
    const moveType = getMoveType(selected);
    
    if (!moveType) { alert("ä¸ç¬¦åˆç‰Œå‹ï¼"); return; }
    
    // æ£€æŸ¥æ˜¯å¦å‹å¾—è¿‡
    if (lastMove.playerIdx !== -1 && lastMove.playerIdx !== 0) {
        const lastType = getMoveType(lastMove.cards);
        if (moveType.type !== 'bomb' && moveType.type !== lastType.type) { alert("ç‰Œå‹ä¸åŒ¹é…"); return; }
        if (moveType.power <= lastType.power) { alert("åˆ†å€¼ä¸å¤Ÿå¤§"); return; }
    }

    // æ‰§è¡Œå‡ºç‰Œ
    players[0] = players[0].filter((_, i) => !selectedCards.has(i));
    finishTurn(0, selected);
}

function handlePass() {
    finishTurn(0, []);
}

function finishTurn(pIdx, cards) {
    if (cards.length > 0) {
        lastMove = { playerIdx: pIdx, cards: cards };
        renderDesk(cards);
    }
    
    if (players[pIdx].length === 0) {
        alert(pIdx === 0 ? "ä½ èµ¢äº†ï¼" : "ç”µè„‘" + pIdx + "èµ¢äº†ï¼");
        startGame();
        return;
    }

    selectedCards.clear();
    currentPlayer = (pIdx + 1) % 3;
    renderAll();
    updateButtons();

    if (currentPlayer !== 0) setTimeout(aiPlay, 1000);
}

function renderDesk(cards) {
    const desk = document.getElementById('desk');
    desk.innerHTML = cards.map(c => `<div class="card ${c.color}"><span class="card-value">${c.value}</span><span class="card-suit">${c.suit}</span></div>`).join('');
}

// æå…¶ç®€é™‹çš„AI
function aiPlay() {
    const hand = players[currentPlayer];
    let playCards = [];

    // å¦‚æœæ˜¯æ–°å›åˆæˆ–è‡ªå·±æœ€å¤§
    if (lastMove.playerIdx === -1 || lastMove.playerIdx === currentPlayer) {
        playCards = [hand[hand.length - 1]]; // éšä¾¿å‡ºä¸€å¼ æœ€å°çš„
    } else {
        const lastType = getMoveType(lastMove.cards);
        // å°è¯•æ‰¾å‡ºä¸€å¼ æ¯”å®ƒå¤§çš„å•å¼ 
        if (lastType.type === 'single') {
            const bigger = hand.find(c => c.power > lastType.power);
            if (bigger) playCards = [bigger];
        }
        // å°è¯•æ‰¾å‡ºå¯¹å­...ï¼ˆæ­¤å¤„å¯æ‰©å±•AIé€»è¾‘ï¼‰
    }

    if (playCards.length > 0) {
        players[currentPlayer] = players[currentPlayer].filter(c => !playCards.includes(c));
        finishTurn(currentPlayer, playCards);
    } else {
        finishTurn(currentPlayer, []);
        // æ˜¾ç¤ºä¸å‡º
        const desk = document.getElementById('desk');
        desk.innerHTML = `<div style="font-size:30px; color:#aaa">ä¸è¦</div>`;
    }
}

// å¯åŠ¨
startGame();
<div id="controls">
    <select id="difficulty-select" onchange="changeDifficulty()">
        <option value="0">éš¾åº¦ï¼šå°ç™½ (ä¹±å‡º)</option>
        <option value="1">éš¾åº¦ï¼šæ–°æ‰‹ (ä¼šå‡ºå¯¹å­)</option>
        <option value="2" selected>éš¾åº¦ï¼šæ™®é€š (æ­£å¸¸å‡ºç‰Œ)</option>
        <option value="3">éš¾åº¦ï¼šè€æ‰‹ (ä¼˜å…ˆè·‘ç‰Œ)</option>
        <option value="4">éš¾åº¦ï¼šé«˜æ‰‹ (æ‡‚å¾—ç•™å¤§ç‰Œ)</option>
        <option value="5">éš¾åº¦ï¼šå¤§å¸ˆ (ä¼šæ‹†ç‰Œå‹åˆ¶)</option>
        <option value="6">éš¾åº¦ï¼šé­”é¬¼ (ç®—åŠ›å…¨å¼€/è®°ç‰Œ)</option>
    </select>
    <button onclick="startGame()">é‡å¼€</button>
    <button id="btn-play" onclick="handlePlay()" disabled>å‡ºç‰Œ</button>
    <button id="btn-pass" onclick="handlePass()" disabled>ä¸è¦</button>
</div>

<script>
// ... ä¿ç•™ä¹‹å‰çš„å˜é‡å®šä¹‰ (VALUES, VALUE_MAP, players ç­‰) ...

let currentDifficulty = 2;

function changeDifficulty() {
    currentDifficulty = parseInt(document.getElementById('difficulty-select').value);
    console.log("å½“å‰éš¾åº¦å·²åˆ‡æ¢è‡³:", currentDifficulty);
}

/**
 * æ ¸å¿ƒä¼˜åŒ–ï¼šæ™ºèƒ½ AI å†³ç­–ç³»ç»Ÿ
 */
function aiPlay() {
    const hand = players[currentPlayer];
    let playCards = [];
    
    // è·å–å½“å‰æ¡Œé¢ä¿¡æ¯
    const lastType = lastMove.playerIdx === -1 || lastMove.playerIdx === currentPlayer ? 
                     null : getMoveType(lastMove.cards);

    // éš¾åº¦ç­–ç•¥é€»è¾‘
    if (!lastType) {
        // AI å…ˆæ‰‹å‡ºç‰Œç­–ç•¥
        playCards = aiChooseBestLeadingCards(hand, currentDifficulty);
    } else {
        // AI è·Ÿç‰Œç­–ç•¥
        playCards = aiChooseResponseCards(hand, lastType, currentDifficulty);
    }

    // æ‰§è¡Œå‡ºç‰Œæˆ–è·³è¿‡
    if (playCards && playCards.length > 0) {
        players[currentPlayer] = players[currentPlayer].filter(c => !playCards.includes(c));
        finishTurn(currentPlayer, playCards);
    } else {
        // å¦‚æœæ˜¯é­”é¬¼éš¾åº¦ï¼Œåœ¨â€œä¸è¦â€ä¹‹å‰ä¼šæ¨¡æ‹Ÿè®¡ç®—æ˜¯å¦æœ‰å¿…è¦æ‹†ç‚¸å¼¹å‹åˆ¶
        finishTurn(currentPlayer, []);
        renderPass(currentPlayer);
    }
}

/**
 * AI ä¸»åŠ¨å‡ºç‰Œé€»è¾‘ (Leading)
 */
function aiChooseBestLeadingCards(hand, level) {
    // è‡ªåŠ¨æŒ‰ power å‡åºæ’åˆ—ï¼Œæ–¹ä¾¿ä»å°ç‰Œå¼€å§‹å‡º
    const sortedHand = [...hand].sort((a,b) => a.power - b.power);
    
    // å°ç™½ï¼šéšç¼˜å‡ºä¸€å¼ æœ€å°çš„
    if (level <= 1) return [sortedHand[0]];
    
    // æ™®é€šåŠä»¥ä¸Šï¼šä¼˜å…ˆæ‰¾æ‰‹é‡Œçš„å¯¹å­ã€é¡ºå­ï¼ˆæ­¤å¤„ç®€åŒ–ä¸ºä¼˜å…ˆå¯¹å­ï¼‰
    const pairs = findPairs(sortedHand);
    if (pairs.length > 0 && level >= 2) return pairs[0];
    
    // è€æ‰‹åŠä»¥ä¸Šï¼šå¦‚æœåªå‰©å‡ å¼ ç‰Œï¼Œä¼˜å…ˆå‡ºå¤§ç‰Œå†²åˆº
    if (level >= 3 && hand.length < 5) return [sortedHand[sortedHand.length - 1]];

    return [sortedHand[0]]; 
}

/**
 * AI è·Ÿç‰Œé€»è¾‘ (Response)
 */
function aiChooseResponseCards(hand, lastType, level) {
    const sortedHand = [...hand].sort((a,b) => a.power - b.power);

    // 1. å°è¯•å¯»æ‰¾ç›¸åŒç‰Œå‹
    let candidates = [];
    if (lastType.type === 'single') {
        candidates = sortedHand.filter(c => c.power > lastType.power);
    } else if (lastType.type === 'pair') {
        const pairs = findPairs(sortedHand);
        candidates = pairs.filter(p => p[0].power > lastType.power);
    }

    // --- éš¾åº¦å·®å¼‚åŒ–å¤„ç† ---
    
    // å°ç™½ (0)ï¼š50% æ¦‚ç‡å³ä½¿æœ‰ç‰Œä¹Ÿä¸å‡ºï¼Œæˆ–è€…æœ‰å¤§ç‰Œä¹±æ”¾
    if (level === 0 && Math.random() > 0.5) return null;

    if (candidates.length > 0) {
        // æ™®é€š (2): å‡ºæ‰‹é‡Œæœ€å°çš„èƒ½å‹ä½çš„ç‰Œ
        if (level <= 2) return (lastType.type === 'pair') ? candidates[0] : [candidates[0]];
        
        // é«˜æ‰‹ (4): å¦‚æœå¯¹æ–¹æ˜¯é˜Ÿå‹ï¼Œä¸å‹å°ç‰Œï¼›å¦‚æœæ˜¯å¯¹æ‰‹ï¼Œæ­»å‘½å‹
        // (æ³¨ï¼šæ­¤ç‰ˆæœ¬æš‚æœªå®ç°å¤æ‚çš„é˜Ÿå‹è¯†åˆ«ï¼Œç®€åŒ–ä¸ºï¼šå¦‚æœæ˜¯å•å¼ ä¸”å¤§äº14(A)ï¼Œè€æ‰‹ä¼šè€ƒè™‘æ˜¯å¦å€¼å¾—å‡º)
        if (level >= 4 && lastType.power >= 14 && hand.length > 5) return null; 

        return (lastType.type === 'pair') ? candidates[0] : [candidates[0]];
    }

    // 2. å°è¯•å‡ºç‚¸å¼¹ (éš¾åº¦ >= 3 æ‰ä¼šä¸»åŠ¨æ‹†ç‚¸å¼¹/ç”¨ç‚¸å¼¹)
    if (level >= 3) {
        const bombs = findBombs(sortedHand);
        if (bombs.length > 0) {
            // å¤§å¸ˆ (5): åªæœ‰å½“å¯¹æ–¹æ‰‹ç‰Œå°‘äº3å¼ ï¼Œæˆ–è€…å¯¹æ–¹å‡ºçš„æ˜¯å¤§ç‰Œæ—¶æ‰ç‚¸
            if (level >= 5 && lastMove.cards.length < 2 && lastType.power < 15) return null;
            return bombs[0];
        }
    }

    return null;
}

// è¾…åŠ©å‡½æ•°ï¼šæ‰¾å¯¹å­
function findPairs(hand) {
    let pairs = [];
    for (let i = 0; i < hand.length - 1; i++) {
        if (hand[i].power === hand[i+1].power) {
            pairs.push([hand[i], hand[i+1]]);
            i++; 
        }
    }
    return pairs;
}

// è¾…åŠ©å‡½æ•°ï¼šæ‰¾ç‚¸å¼¹
function findBombs(hand) {
    // é€»è¾‘ï¼šå¯»æ‰¾å››å¼ ä¸€æ ·çš„
    let bombs = [];
    let counts = {};
    hand.forEach(c => counts[c.power] = (counts[c.power] || 0) + 1);
    for (let p in counts) {
        if (counts[p] === 4) {
            bombs.push(hand.filter(c => c.power == p));
        }
    }
    // ç‹ç‚¸åˆ¤æ–­
    const jokers = hand.filter(c => c.power >= 16);
    if (jokers.length === 2) bombs.push(jokers);
    return bombs;
}

function renderPass(pIdx) {
    const desk = document.getElementById('desk');
    const tip = pIdx === 1 ? "å·¦ç”µè„‘ï¼šä¸è¦" : "å³ç”µè„‘ï¼šä¸è¦";
    desk.innerHTML = `<div style="font-size:24px; color:#ffeb3b; text-shadow: 2px 2px 4px #000;">${tip}</div>`;
}

// ... å…¶ä½™æ¸²æŸ“å’Œåˆå§‹åŒ–é€»è¾‘ä¿æŒä¸å˜ ...
</script>
</body>
</html>
