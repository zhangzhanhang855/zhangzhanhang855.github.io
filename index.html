<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æç®€æ–—åœ°ä¸» - äººæœºå¯¹æˆ˜</title>
    <style>
        :root {
            --bg-color: #2d5a27;
            --card-white: #ffffff;
            --card-red: #ff4d4d;
            --card-black: #333;
        }
        body { background-color: var(--bg-color); font-family: "Microsoft YaHei", sans-serif; margin: 0; overflow: hidden; color: white; }
        
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: space-between; }

        /* ç©å®¶åŒºåŸŸå¸ƒå±€ */
        .player-area { position: absolute; display: flex; flex-wrap: wrap; justify-content: center; width: 100%; transition: all 0.3s; }
        #player-bottom { bottom: 20px; height: 150px; }
        #player-left { left: 20px; top: 30%; width: 100px; flex-direction: column; }
        #player-right { right: 20px; top: 30%; width: 100px; flex-direction: column; }

        /* å¡ç‰Œæ ·å¼ */
        .card {
            width: 70px; height: 100px;
            background: var(--card-white);
            border-radius: 8px;
            margin: -25px 5px 0; /* å æ”¾æ•ˆæœ */
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 5px; box-sizing: border-box;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            cursor: pointer; position: relative; transition: transform 0.2s;
            user-select: none; border: 1px solid #ccc;
        }
        .card.selected { transform: translateY(-20px); border: 2px solid #ffeb3b; }
        .card.red { color: var(--card-red); }
        .card.black { color: var(--card-black); }
        .card-value { font-size: 20px; font-weight: bold; }
        .card-suit { font-size: 14px; align-self: flex-end; }

        /* éšè—å¯¹æ‰‹æ‰‹ç‰Œå†…å®¹ */
        .hidden-card { background: linear-gradient(135deg, #1a3a16 25%, #2d5a27 100%); border: 1px solid #ffffff55; }
        .hidden-card * { display: none; }

        /* æ§åˆ¶åŒº */
        #controls { position: absolute; bottom: 200px; width: 100%; display: flex; justify-content: center; gap: 20px; }
        button { padding: 10px 25px; font-size: 16px; border-radius: 20px; border: none; cursor: pointer; background: #f0ad4e; color: white; font-weight: bold; }
        button:hover { background: #ec971f; }
        button:disabled { background: #777; cursor: not-allowed; }

        /* æ¡Œé¢/å‡ºç‰ŒåŒº */
        #desk { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 10px; }
        .info-tag { background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; position: absolute; font-size: 12px; }
        
        #dizhu-cards { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="dizhu-cards"></div>
    
    <div class="info-tag" style="top:30%; left:130px;">ç”µè„‘1 (<span id="count1">0</span>å¼ )</div>
    <div id="player-left" class="player-area"></div>
    
    <div class="info-tag" style="top:30%; right:130px;">ç”µè„‘2 (<span id="count2">0</span>å¼ )</div>
    <div id="player-right" class="player-area"></div>

    <div id="desk"></div>

    <div id="controls">
        <button onclick="startGame()">é‡æ–°å¼€å§‹</button>
        <button id="btn-play" onclick="handlePlay()" disabled>å‡ºç‰Œ</button>
        <button id="btn-pass" onclick="handlePass()" disabled>ä¸è¦</button>
    </div>

    <div id="player-bottom" class="player-area"></div>
</div>

<script>
/** * æç®€æ–—åœ°ä¸»æ ¸å¿ƒé€»è¾‘
 */
const VALUES = ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2', 'å°ç‹', 'å¤§ç‹'];
const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
const VALUE_MAP = { '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14, '2':15, 'å°ç‹':16, 'å¤§ç‹':17 };

let deck = [];
let players = [[], [], []]; // 0: ç©å®¶, 1: å·¦ç”µè„‘, 2: å³ç”µè„‘
let lastMove = { playerIdx: -1, cards: [] }; 
let currentPlayer = 0;
let selectedCards = new Set();

// åˆå§‹åŒ–ç‰Œç»„
function createDeck() {
    deck = [];
    for (let v of VALUES.slice(0, 13)) {
        for (let s of SUITS) deck.push({ value: v, suit: s, power: VALUE_MAP[v], color: (s==='â™¥'||s==='â™¦'?'red':'black') });
    }
    deck.push({ value: 'å°ç‹', suit: 'ğŸƒ', power: 16, color: 'black' });
    deck.push({ value: 'å¤§ç‹', suit: 'ğŸƒ', power: 17, color: 'red' });
}

// æ´—ç‰Œå¹¶å‘ç‰Œ
function startGame() {
    createDeck();
    deck.sort(() => Math.random() - 0.5);
    
    players = [
        deck.slice(0, 17).sort((a,b) => b.power - a.power),
        deck.slice(17, 34).sort((a,b) => b.power - a.power),
        deck.slice(34, 51).sort((a,b) => b.power - a.power)
    ];
    
    // ç®€å•èµ·è§ï¼Œè¿™é‡Œå›ºå®šåœ°ä¸»ç‰Œç»™ç©å®¶(0)
    const dizhuCards = deck.slice(51);
    players[0] = [...players[0], ...dizhuCards].sort((a,b) => b.power - a.power);
    
    renderDizhuCards(dizhuCards);
    currentPlayer = 0;
    lastMove = { playerIdx: -1, cards: [] };
    selectedCards.clear();
    renderAll();
    updateButtons();
}

function renderDizhuCards(cards) {
    const container = document.getElementById('dizhu-cards');
    container.innerHTML = cards.map(c => `<div class="card ${c.color}" style="width:40px;height:60px;margin:0 2px;font-size:12px;">${c.value}</div>`).join('');
}

function renderAll() {
    // æ¸²æŸ“ç©å®¶æ‰‹ç‰Œ
    const pBottom = document.getElementById('player-bottom');
    pBottom.innerHTML = '';
    players[0].forEach((card, index) => {
        const div = document.createElement('div');
        div.className = `card ${card.color} ${selectedCards.has(index) ? 'selected' : ''}`;
        div.innerHTML = `<span class="card-value">${card.value}</span><span class="card-suit">${card.suit}</span>`;
        div.onclick = () => {
            if(selectedCards.has(index)) selectedCards.delete(index);
            else selectedCards.add(index);
            renderAll();
        };
        pBottom.appendChild(div);
    });

    // æ¸²æŸ“ç”µè„‘æ‰‹ç‰Œï¼ˆéšè—ï¼‰
    document.getElementById('player-left').innerHTML = players[1].map(() => '<div class="card hidden-card"></div>').join('');
    document.getElementById('player-right').innerHTML = players[2].map(() => '<div class="card hidden-card"></div>').join('');
    document.getElementById('count1').innerText = players[1].length;
    document.getElementById('count2').innerText = players[2].length;
}

function updateButtons() {
    document.getElementById('btn-play').disabled = (currentPlayer !== 0);
    document.getElementById('btn-pass').disabled = (currentPlayer !== 0 || lastMove.playerIdx === -1 || lastMove.playerIdx === 0);
}

// ç®€å•çš„ç‰Œå‹æ ¡éªŒ
function getMoveType(cards) {
    const len = cards.length;
    if (len === 0) return null;
    const sorted = [...cards].sort((a,b) => a.power - b.power);
    
    if (len === 1) return { type: 'single', power: sorted[0].power };
    if (len === 2 && sorted[0].power === sorted[1].power) return { type: 'pair', power: sorted[0].power };
    if (len === 2 && sorted[0].power >= 16 && sorted[1].power >= 16) return { type: 'bomb', power: 99 }; // ç‹ç‚¸
    if (len === 4 && sorted[0].power === sorted[3].power) return { type: 'bomb', power: sorted[0].power };
    
    // æ›´å¤šç‰Œå‹ï¼ˆé¡ºå­ã€ä¸‰å¸¦ç­‰ï¼‰æ­¤å¤„å¯æ‰©å±•...
    return null; 
}

function handlePlay() {
    const selected = Array.from(selectedCards).map(i => players[0][i]);
    const moveType = getMoveType(selected);
    
    if (!moveType) { alert("ä¸ç¬¦åˆç‰Œå‹ï¼"); return; }
    
    // æ£€æŸ¥æ˜¯å¦å‹å¾—è¿‡
    if (lastMove.playerIdx !== -1 && lastMove.playerIdx !== 0) {
        const lastType = getMoveType(lastMove.cards);
        if (moveType.type !== 'bomb' && moveType.type !== lastType.type) { alert("ç‰Œå‹ä¸åŒ¹é…"); return; }
        if (moveType.power <= lastType.power) { alert("åˆ†å€¼ä¸å¤Ÿå¤§"); return; }
    }

    // æ‰§è¡Œå‡ºç‰Œ
    players[0] = players[0].filter((_, i) => !selectedCards.has(i));
    finishTurn(0, selected);
}

function handlePass() {
    finishTurn(0, []);
}

function finishTurn(pIdx, cards) {
    if (cards.length > 0) {
        lastMove = { playerIdx: pIdx, cards: cards };
        renderDesk(cards);
    }
    
    if (players[pIdx].length === 0) {
        alert(pIdx === 0 ? "ä½ èµ¢äº†ï¼" : "ç”µè„‘" + pIdx + "èµ¢äº†ï¼");
        startGame();
        return;
    }

    selectedCards.clear();
    currentPlayer = (pIdx + 1) % 3;
    renderAll();
    updateButtons();

    if (currentPlayer !== 0) setTimeout(aiPlay, 1000);
}

function renderDesk(cards) {
    const desk = document.getElementById('desk');
    desk.innerHTML = cards.map(c => `<div class="card ${c.color}"><span class="card-value">${c.value}</span><span class="card-suit">${c.suit}</span></div>`).join('');
}

// æå…¶ç®€é™‹çš„AI
function aiPlay() {
    const hand = players[currentPlayer];
    let playCards = [];

    // å¦‚æœæ˜¯æ–°å›åˆæˆ–è‡ªå·±æœ€å¤§
    if (lastMove.playerIdx === -1 || lastMove.playerIdx === currentPlayer) {
        playCards = [hand[hand.length - 1]]; // éšä¾¿å‡ºä¸€å¼ æœ€å°çš„
    } else {
        const lastType = getMoveType(lastMove.cards);
        // å°è¯•æ‰¾å‡ºä¸€å¼ æ¯”å®ƒå¤§çš„å•å¼ 
        if (lastType.type === 'single') {
            const bigger = hand.find(c => c.power > lastType.power);
            if (bigger) playCards = [bigger];
        }
        // å°è¯•æ‰¾å‡ºå¯¹å­...ï¼ˆæ­¤å¤„å¯æ‰©å±•AIé€»è¾‘ï¼‰
    }

    if (playCards.length > 0) {
        players[currentPlayer] = players[currentPlayer].filter(c => !playCards.includes(c));
        finishTurn(currentPlayer, playCards);
    } else {
        finishTurn(currentPlayer, []);
        // æ˜¾ç¤ºä¸å‡º
        const desk = document.getElementById('desk');
        desk.innerHTML = `<div style="font-size:30px; color:#aaa">ä¸è¦</div>`;
    }
}

// å¯åŠ¨
startGame();
</script>
</body>
</html>
