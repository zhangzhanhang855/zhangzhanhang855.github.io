<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>PIXEL POKER: SONIC APOCALYPSE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --bg: #0d0d15;
            --pixel-gold: #ffcf00;
            --pixel-red: #ff3333;
            --pixel-white: #f0f0f0;
        }

        body {
            margin: 0; background-color: var(--bg);
            font-family: 'Press Start 2P', cursive;
            color: white; image-rendering: pixelated; overflow: hidden;
            transition: background 0.1s;
        }

        /* 炸弹崩坏特效 */
        @keyframes shockwave {
            0% { transform: scale(1); filter: brightness(1); }
            20% { transform: scale(1.15); filter: brightness(5) invert(1); }
            40% { transform: scale(0.9); filter: brightness(2); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .bomb-effect { animation: shockwave 0.6s steps(4) forwards; }
        
        @keyframes bg-glitch {
            0% { background: #ff0000; }
            20% { background: #000; }
            40% { background: #ff0000; }
            100% { background: var(--bg); }
        }
        .glitch-bg { animation: bg-glitch 0.4s steps(2); }

        #stage { height: 100vh; display: flex; flex-direction: column; padding: 40px; box-sizing: border-box; }

        #ui-top {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border: 4px solid var(--pixel-white);
            background: #1a1a2e; box-shadow: 8px 8px 0px #000;
        }

        #timer { font-size: 18px; color: var(--pixel-gold); }
        .critical { color: var(--pixel-red) !important; animation: pulse 0.2s infinite; }
        @keyframes pulse { 50% { opacity: 0; } }

        .hand-area { display: flex; justify-content: center; align-items: center; min-height: 160px; position: relative; }
        
        .card {
            width: 80px; height: 110px; background: var(--pixel-white);
            color: #000; border: 4px solid #000; margin-left: -45px;
            display: flex; flex-direction: column; padding: 8px; box-sizing: border-box;
            cursor: pointer; position: relative; box-shadow: 4px 4px 0px rgba(0,0,0,0.8);
            transition: transform 0.1s, top 0.2s;
        }
        .card.selected { transform: translateY(-40px) !important; border-color: var(--pixel-gold); z-index: 100 !important; }
        .card.back { background: #2244aa; border-color: #fff; }
        .card.red { color: var(--pixel-red); }
        .card .v { font-size: 16px; line-height: 1; }

        #desk {
            flex: 1; margin: 25px 0; border: 4px solid #222;
            background: rgba(255,255,255,0.03); display: flex; flex-direction: column;
            justify-content: center; align-items: center; position: relative;
        }

        .controls { display: flex; justify-content: center; gap: 30px; height: 70px; visibility: hidden; }
        .controls.active { visibility: visible; }

        button {
            padding: 15px 30px; background: #fff; border: 4px solid #000;
            font-family: inherit; font-size: 12px; cursor: pointer;
            box-shadow: 6px 6px 0px var(--pixel-gold);
        }
        button:active { transform: translate(3px, 3px); box-shadow: none; }
    </style>
</head>
<body>

<div id="stage">
    <div id="ui-top">
        <div>CPU:<span id="comp-count">0</span></div>
        <div id="timer">30</div>
        <button onclick="initGame()">REBOOT</button>
    </div>

    <div id="hand-1" class="hand-area"></div>

    <div id="desk">
        <div id="desk-1" class="hand-area"></div>
        <div id="desk-0" class="hand-area"></div>
    </div>

    <div class="controls" id="ui">
        <button id="btn-play" onclick="handlePlay()">EXECUTE</button>
        <button id="btn-pass" onclick="handlePass()">SKIP</button>
    </div>

    <div id="hand-0" class="hand-area"></div>
</div>

<script>
/** --- 音效合成引擎 --- **/
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    const now = audioCtx.currentTime;

    if (type === 'select') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(600, now);
        osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start();
        osc.stop(now + 0.1);
    } else if (type === 'play') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.2);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.2);
        osc.start();
        osc.stop(now + 0.2);
    } else if (type === 'bomb') {
        // 噪音发生器用于爆炸感
        const bufferSize = audioCtx.sampleRate * 0.5;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        const noiseGain = audioCtx.createGain();
        noise.connect(noiseGain);
        noiseGain.connect(audioCtx.destination);

        noiseGain.gain.setValueAtTime(0.3, now);
        noiseGain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
        noise.start();
        noise.stop(now + 0.5);

        // 同时加一个低频方波
        osc.type = 'square';
        osc.frequency.setValueAtTime(100, now);
        osc.frequency.linearRampToValueAtTime(40, now + 0.4);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.4);
        osc.start();
        osc.stop(now + 0.4);
    }
}

/** --- 游戏核心逻辑 (继承最强AI与不规则手牌) --- **/
const POWER = { '3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14,'2':15,'S':16,'B':17 };
let G = { hands: [[], []], last: null, turn: 0, selected: new Set(), timeLeft: 30, timerInt: null };

function initGame() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    let deck = [];
    for(let v in POWER) {
        if(v==='S'||v==='B') deck.push({v, p:POWER[v], s:'*', c:v==='B'?'red':'black'});
        else ['H','D','S','C'].forEach(s => deck.push({v, p:POWER[v], s, c:(s==='H'||s==='D'?'red':'black')}));
    }
    deck.sort(() => Math.random() - 0.5);
    G.hands = [deck.slice(0, 27).sort((a,b)=>b.p-a.p), deck.slice(27, 54).sort((a,b)=>b.p-a.p)];
    G.last = null; G.turn = 0; G.selected.clear();
    renderAll();
    resetTimer();
}

function getInfo(cards) {
    if(!cards.length) return null;
    let counts = {};
    cards.forEach(c => counts[c.p] = (counts[c.p] || 0) + 1);
    let vals = Object.entries(counts).map(e=>({p:Number(e[0]), c:e[1]})).sort((a,b)=>b.c-a.c || b.p-a.p);
    let len = cards.length;
    let m = vals[0];

    if(m.c === 4 && len === 4) return { type: 'bomb', p: m.p, weight: 800 + m.p };
    if(len === 2 && cards[0].p >= 16 && cards[1].p >= 16) return { type: 'bomb', p: 99, weight: 2000 };
    if(len === 1) return { type: 'single', p: m.p };
    if(len === 2 && m.c === 2) return { type: 'pair', p: m.p };
    if(len >= 5 && vals.every(v => v.c === 1)) {
        let ps = vals.map(v => v.p).sort((a,b)=>a-b);
        if(ps[len-1] < 15 && ps[len-1]-ps[0] === len-1) return { type: 'straight', p: ps[0], len };
    }
    return null; 
}

/** AI 与流程控制 **/
function aiPlay() {
    const hand = G.hands[1];
    let toPlay = [];
    if(!G.last || G.last.player === 1) {
        for(let l=12; l>=5; l--) { let s = findStraight(hand, l); if(s) { toPlay = s; break; } }
        if(!toPlay.length) toPlay = [hand[hand.length-1]];
    } else {
        const lastI = getInfo(G.last.cards);
        let matches = [];
        for(let n=1; n<=12; n++){
            for(let i=0; i<=hand.length-n; i++){
                let sub = hand.slice(i, i+n); let info = getInfo(sub);
                if(info && (info.type === lastI.type || info.type === 'bomb') && (info.len === lastI.len || info.type === 'bomb')){
                    if(info.type === 'bomb' && lastI.type !== 'bomb') matches.push(sub);
                    else if(info.p > lastI.p) matches.push(sub);
                }
            }
        }
        if(matches.length) toPlay = matches.sort((a,b)=>getInfo(a).p - getInfo(b).p)[0];
    }
    if(toPlay.length) {
        if(getInfo(toPlay).type === 'bomb') playSound('bomb'); else playSound('play');
        execute(toPlay); 
    } else handlePass();
}

function findStraight(hand, len) {
    let u = [...new Set(hand.map(c=>c.p))].filter(p=>p<15).sort((a,b)=>a-b);
    for(let i=0; i<=u.length-len; i++){
        let sub = u.slice(i, i+len);
        if(sub[len-1]-sub[0] === len-1) return sub.map(p=>hand.find(c=>c.p===p));
    }
    return null;
}

function execute(cards) {
    G.hands[G.turn] = G.hands[G.turn].filter(c => !cards.includes(c));
    G.last = { player: G.turn, cards };
    if(getInfo(cards).type === 'bomb') {
        document.body.classList.add('glitch-bg');
        document.getElementById('desk').classList.add('bomb-effect');
        setTimeout(() => {
            document.body.classList.remove('glitch-bg');
            document.getElementById('desk').classList.remove('bomb-effect');
        }, 600);
    }
    document.getElementById(`desk-${G.turn}`).innerHTML = renderCards(cards);
    if(G.hands[G.turn].length === 0) { alert(G.turn === 0 ? "PLAYER WIN" : "CPU WIN"); initGame(); return; }
    G.selected.clear(); G.turn = 1 - G.turn;
    document.getElementById(`desk-${G.turn}`).innerHTML = "";
    renderAll(); resetTimer();
    if(G.turn === 1) setTimeout(aiPlay, 800);
}

function handlePlay() {
    let cards = Array.from(G.selected).map(i => G.hands[0][i]);
    let info = getInfo(cards);
    if(!info) return;
    if(G.last && G.last.player !== 0) {
        let l = getInfo(G.last.cards);
        if(info.type==='bomb'){ if(l.type==='bomb' && info.weight<=l.weight) return; }
        else { if(info.type!==l.type || info.len!==l.len || info.p<=l.p) return; }
    }
    if(info.type === 'bomb') playSound('bomb'); else playSound('play');
    execute(cards);
}

function handlePass() {
    if(!G.last || G.last.player === G.turn) return;
    document.getElementById(`desk-${G.turn}`).innerHTML = "<div style='color:#444'>[PASS]</div>";
    G.turn = 1 - G.turn;
    document.getElementById(`desk-${G.turn}`).innerHTML = "";
    renderAll(); resetTimer();
    if(G.turn === 1) setTimeout(aiPlay, 800);
}

function resetTimer() {
    clearInterval(G.timerInt); G.timeLeft = 30;
    const el = document.getElementById('timer'); el.classList.remove('critical');
    G.timerInt = setInterval(() => {
        G.timeLeft--; el.innerText = G.timeLeft;
        if(G.timeLeft < 7) el.classList.add('critical');
        if(G.timeLeft <= 0) G.turn === 0 ? handlePass() : aiPlay();
    }, 1000);
}

function renderAll() {
    document.getElementById('comp-count').innerText = G.hands[1].length;
    document.getElementById('hand-1').innerHTML = G.hands[1].map(() => `<div class="card back" style="margin-left:-60px"></div>`).join('');
    const h0 = document.getElementById('hand-0'); h0.innerHTML = "";
    G.hands[0].forEach((c, i) => {
        const deg = (Math.random() * 8 - 4).toFixed(1); const offY = (Math.random() * 12 - 6).toFixed(1);
        const div = document.createElement('div');
        div.className = `card ${c.c} ${G.selected.has(i)?'selected':''}`;
        div.style.transform = `rotate(${deg}deg)`; div.style.top = `${offY}px`;
        div.innerHTML = `<span class="v">${c.v}</span><span style="font-size:10px; align-self:flex-end;">${c.s}</span>`;
        div.onclick = () => { playSound('select'); G.selected.has(i)?G.selected.delete(i):G.selected.add(i); renderAll(); };
        h0.appendChild(div);
    });
    document.getElementById('ui').className = G.turn === 0 ? 'controls active' : 'controls';
}

function renderCards(cards) {
    return cards.map(c => `<div class="card ${c.c}" style="margin-left:-50px; transform:scale(0.9); cursor:default"><span class="v">${c.v}</span><span>${c.s}</span></div>`).join('');
}

initGame();
</script>
</body>
</html>
